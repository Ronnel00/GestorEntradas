@page "/entradas/create"
@inject EntradasService entradasService
@inject NavigationManager nav
@rendermode InteractiveServer

@code {
	public Entrada Entrada { get; set; } = new Entrada();
	public List<Producto> ListaProductos { get; set; } = new List<Producto>();
	public EntradaDetalle DetalleSeleccionado { get; set; } = new EntradaDetalle();

	public string? errorMensaje { get; set; }

	protected override async Task OnInitializedAsync()
	{
		ListaProductos = await entradasService.ListarProductos();
	}

	private async Task Guardar()
	{
		var creado = await entradasService.Guardar(Entrada);

		if (creado)
		{
			nav.NavigateTo("/entradas");
		}
		else
		{
			errorMensaje = "No se pudo crear la entrada.";
		}
	}

	private async Task AgregarDetalle()
	{
		errorMensaje = null;

		if (DetalleSeleccionado.ProductoId == 0)
		{
			errorMensaje = "Debe seleccionar al menos 1 producto.";
		}
		else if (DetalleSeleccionado.Cantidad <= 0)
		{
			errorMensaje = "La cantidad debe ser mayor que 0.";
		}
		else if (DetalleSeleccionado.Costo <= 0)
		{
			errorMensaje = "El costo debe ser mayor que 0.";
		}

		var producto = ListaProductos.Single(p => p.ProductoId == DetalleSeleccionado.ProductoId);

		var detalle = new EntradaDetalle
		{
			ProductoId = producto.ProductoId,
			Cantidad = DetalleSeleccionado.Cantidad,
			Costo = DetalleSeleccionado.Costo
		};

		Entrada.Detalles.Add(detalle);
		DetalleSeleccionado = new EntradaDetalle();
		await Task.CompletedTask;
	}

	private void RemoverDetalle(EntradaDetalle detalle)
	{
		Entrada.Detalles.Remove(detalle);
		DetalleSeleccionado = detalle;
	}
}
